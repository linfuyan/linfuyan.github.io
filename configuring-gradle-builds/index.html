<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>配置 Gradle 构建 | 悠城札记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本节基于Android 构建系统概览和从 Android Studio 构建并运行来展示如何基于产品口味和构建类型来使用构建变种。
构建配置基础Android Studio 项目包含一个顶级的构建文件以及每个模块下的一个构建文件。构建文件名为 build.gradle，他们是普通的文本文件，通过 Gradle 的 Android 插件提供的元素，使用 Groovy 语法来配置构建过程。大多数情况下">
<meta property="og:type" content="article">
<meta property="og:title" content="配置 Gradle 构建">
<meta property="og:url" content="http://yoursite.com/configuring-gradle-builds/index.html">
<meta property="og:site_name" content="悠城札记">
<meta property="og:description" content="本节基于Android 构建系统概览和从 Android Studio 构建并运行来展示如何基于产品口味和构建类型来使用构建变种。
构建配置基础Android Studio 项目包含一个顶级的构建文件以及每个模块下的一个构建文件。构建文件名为 build.gradle，他们是普通的文本文件，通过 Gradle 的 Android 插件提供的元素，使用 Groovy 语法来配置构建过程。大多数情况下">
<meta property="og:image" content="https://developer.android.com/images/tools/as-gradlesync.png">
<meta property="og:image" content="https://developer.android.com/images/tools/as-demoflavordirs.png">
<meta property="og:image" content="https://developer.android.com/images/tools/as-buildvariants.png">
<meta property="og:updated_time" content="2015-08-29T09:20:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="配置 Gradle 构建">
<meta name="twitter:description" content="本节基于Android 构建系统概览和从 Android Studio 构建并运行来展示如何基于产品口味和构建类型来使用构建变种。
构建配置基础Android Studio 项目包含一个顶级的构建文件以及每个模块下的一个构建文件。构建文件名为 build.gradle，他们是普通的文本文件，通过 Gradle 的 Android 插件提供的元素，使用 Groovy 语法来配置构建过程。大多数情况下">
  
    <link rel="alternative" href="/atom.xml" title="悠城札记" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://tp2.sinaimg.cn/1132654561/180/5670253112/1" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">linfuyan</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Android-Studio/" style="font-size: 20px;">Android Studio</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Gradle/" style="font-size: 20px;">Gradle</a> <a href="/tags/cocoapods/" style="font-size: 10px;">cocoapods</a> <a href="/tags/fir-im/" style="font-size: 10px;">fir.im</a> <a href="/tags/git/" style="font-size: 20px;">git</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/产品口味/" style="font-size: 10px;">产品口味</a> <a href="/tags/价值/" style="font-size: 10px;">价值</a> <a href="/tags/分支模型/" style="font-size: 10px;">分支模型</a> <a href="/tags/原则/" style="font-size: 10px;">原则</a> <a href="/tags/工作流/" style="font-size: 10px;">工作流</a> <a href="/tags/应用程序/" style="font-size: 10px;">应用程序</a> <a href="/tags/持续集成/" style="font-size: 10px;">持续集成</a> <a href="/tags/构建变种/" style="font-size: 10px;">构建变种</a> <a href="/tags/构建类型/" style="font-size: 10px;">构建类型</a> <a href="/tags/构建系统/" style="font-size: 20px;">构建系统</a> <a href="/tags/生命周期/" style="font-size: 10px;">生命周期</a> <a href="/tags/程序员/" style="font-size: 10px;">程序员</a> <a href="/tags/聪明人/" style="font-size: 10px;">聪明人</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://runoob.com">菜鸟教程</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://vqianduan.com">微前端</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://zuimeiui.com">最美UI</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">linfuyan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://tp2.sinaimg.cn/1132654561/180/5670253112/1" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">linfuyan</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-configuring-gradle-builds" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/configuring-gradle-builds/" class="article-date">
  	<time datetime="2015-08-14T09:27:43.000Z" itemprop="datePublished">2015-08-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      配置 Gradle 构建
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-Studio/">Android Studio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gradle/">Gradle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/产品口味/">产品口味</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/构建变种/">构建变种</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/构建类型/">构建类型</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/构建系统/">构建系统</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/软件工具/">软件工具</a><a class="article-category-link" href="/categories/软件工具/Gradle/">Gradle</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本节基于<a href="http://www.linfuyan.com/android-build-system-overview" target="_blank" rel="external">Android 构建系统概览</a>和<a href="">从 Android Studio 构建并运行</a>来展示如何基于产品口味和构建类型来使用构建变种。</p>
<h2 id="构建配置基础">构建配置基础</h2><p>Android Studio 项目包含一个顶级的构建文件以及每个模块下的一个构建文件。构建文件名为 <code>build.gradle</code>，他们是普通的文本文件，通过 Gradle 的 Android 插件提供的元素，使用 <a href="http://groovy.codehaus.org/" target="_blank" rel="external">Groovy</a> 语法来配置构建过程。大多数情况下，你只需要在模块层级上来编辑构建文件。例如在项目 <code>BuildSystemExample</code> 的 app 模块的构建文件看起来像这样：</p>
<a id="more"></a>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">19</span></span><br><span class="line">    buildToolsVersion <span class="string">"19.0.0"</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">8</span></span><br><span class="line">        targetSdkVersion <span class="number">19</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">":lib"</span>)</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:19.0.1'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>apply plugin: &#39;com.android.application&#39;</code> 说明应用 Gradle 的 Android 插件来构建。这将为顶级的构建任务新增 Android 指定的构建任务，并添加 <code>android {...}</code> 元素为 Android 指定的构建选项。</p>
<p><code>android {...}</code> 则配置所有 Android 指定的构建选项：</p>
<ul>
<li><code>compileSdkVersion</code> 属性指定编译目标版本。</li>
<li><code>buildToolVersion</code> 属性指定采用那个版本的构建工具。想要安装不同版本的构建工具，可以使用 SDK 管理器。</li>
</ul>
<blockquote>
<p><strong>注意：</strong> 永远要使用版本号比你所用的编译目标或者目标 SDK 的主要修订号高的或者相等的构建工具。</p>
</blockquote>
<ul>
<li><code>defaultConfig</code> 元素动态地配置构建系统中的清单文件( <code>AndroidManifest.xml</code> )的核心设置和条目。 <code>defaultConfig</code> 中的值将覆盖清单文件中的对应值。<br><code>defaultConfig</code> 元素中的指定配置将被应用到所有构建变种，除非某个构建变种的配置覆盖了其中的一些值。</li>
<li><code>buildTypes</code> 元素控制如何构建和打包应用程序。 构建系统默认定义了两个构建类型： debug 和 release。 debug 构建类型包含调试标志，并使用 debug 密钥签名。 release 构建类型默认是为签名的。这个实例中构建文件配置了 release 版本使用混淆。</li>
</ul>
<p><code>dependencies</code> 元素位于 <code>android</code> 元素之外，在其后面。该元素申明这个模块的依赖。依赖将在后面的章节中说明。</p>
<blockquote>
<p><strong>注意：</strong> 当你修改了项目中的构建文件， Android Studio 需要一个项目同步来导入构建配置的改变。点击出现在 Android Studio 黄色通知栏上的 <strong>Sync Now</strong> 按钮来导入这些变化。</p>
</blockquote>
<p><img src="https://developer.android.com/images/tools/as-gradlesync.png" alt="Sync the project in Andriod Studio"></p>
<h3 id="声明依赖">声明依赖</h3><p>实例中的 app 模块声明了3个依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// Module dependency</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">":lib"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remote binary dependency</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:19.0.1'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Local binary dependency</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每种依赖将在下面描述。构建系统添加所有的 <code>compile</code> 依赖到编译类路径中，并在最终的安装包中包含他们。</p>
<h4 id="模块依赖">模块依赖</h4><p><code>app</code> 模块依赖 <code>lib</code> 模块，因为如<a href="https://developer.android.com/intl/zh-cn/tools/building/configuring-gradle.html#openActFromLib" target="_blank" rel="external">从一个库模块中开启 Activity </a> 中 <code>MainActivity</code> 启动 <code>LibActivity1</code>。</p>
<p><code>compile project(&quot;:lib&quot;)</code> 声明对 <code>BuildSystemExample</code> 中 <code>lib</code> 模块的依赖。当你构建 <code>app</code> 模块时，构建系统将组装和包含 <code>lib</code> 模块。</p>
<h4 id="远程二进制依赖">远程二进制依赖</h4><p><code>app</code> 和 <code>lib</code> 模块都使用 Android Support 库中的 <code>ActionBarActivity</code> 类，所以这些模块依赖于它。</p>
<p><code>compile &#39;com.android.support:appcompat-v7:19.0.1&#39;</code> 通过指定 Android Support 库的 Maven 坐标来声明对该库 19.0.1 版本的依赖。Android Support 库被打包在 Android SDK 的 Android 仓库中。如果你安装的 SDK 中不包含该安装包，可以通过 SDK 管理器来下载并安装。</p>
<p>Android Studio 默认配置项目使用 Maven 中央仓库。(该配置包含在项目的顶级构建文件中)。</p>
<h4 id="本地二进制依赖">本地二进制依赖</h4><p>一些模块没有用到本地文件系统的任何二进制依赖。如果你拥有一些模块需要本地二进制依赖，复制这些依赖中的 JAR 文件 到你项目中的 <code>&lt;moduleName&gt;/libs</code> 目录下。</p>
<p><code>compile fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])</code> 告诉构建系统所有 <code>app/libs</code> 下的 JAR 文件都是依赖，将被包含在编译类路径和最终安装包中。</p>
<p>想了解 Gradle 的依赖更多信息，查看 Gradle 用户指南中的<a href="http://www.gradle.org/docs/current/userguide/artifact_dependencies_tutorial.html" target="_blank" rel="external">以来管理基础</a>。</p>
<h3 id="运行混淆">运行混淆</h3><p>构建系统可以在构建过程中运行 <a href="http://developer.android.com/tools/help/proguard.html" target="_blank" rel="external">ProGuard</a> 来混淆类，通过修改 <code>app</code> 模块中的构建文件来为 release 构建运行 ProGuard：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">...</span></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">...</span></span><br></pre></td></tr></table></figure>
<p><code>getDefaultProguardFile(&#39;proguard-android.txt&#39;)</code> 从 Android SDK 安装路径下获取默认的 ProGuard 设置。 Android Studio 在模块根目录下添加模块指定的规则文件 <code>proguard-rules.pro</code>， 这样你可以添加自定义的 ProGuard 规则。</p>
<h3 id="安装包标识：应用程序ID">安装包标识：应用程序ID</h3><p>在 Android 构建系统中， applicationId 属性是用来唯一标识发布的应用程序包的。 applicationId 在 <code>build.gradle</code> 文件中的 android 部分设置。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">apply</span> plugin: <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="title">compileSdkVersion</span> <span class="number">19</span></span><br><span class="line">    buildToolsVersion <span class="string">"19.1"</span></span><br><span class="line"></span><br><span class="line">defaultConfig &#123;</span><br><span class="line">    <span class="title">applicationId</span> <span class="string">"com.example.my.app"</span></span><br><span class="line">    minSdkVersion <span class="number">15</span></span><br><span class="line">    targetSdkVersion <span class="number">19</span></span><br><span class="line">    versionCode <span class="number">1</span></span><br><span class="line">    versionName <span class="string">"1.0"</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong> applicationId 只能在 <code>build.gradle</code> 文件中指定，而不能在 AndroidManifest.xml 中。</p>
</blockquote>
<p>在使用构建变种时，构建系统允许为每个产品修饰和构建类型唯一的标识不同的安装包。 构建类型中的 applicationId 被添加为后缀，以便指定产品修饰。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">productFlavors</span> &#123;</span><br><span class="line">       <span class="title">pro</span> &#123;</span><br><span class="line">           <span class="title">applicationId</span> = <span class="string">"com.example.my.pkg.pro"</span></span><br><span class="line">       &#125;</span><br><span class="line">       free &#123;</span><br><span class="line">           <span class="title">applicationId</span> = <span class="string">"com.example.my.pkg.free"</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   buildTypes &#123;</span><br><span class="line">       <span class="title">debug</span> &#123;</span><br><span class="line">           <span class="title">applicationIdSuffix</span> <span class="string">".debug"</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ....</span><br></pre></td></tr></table></figure>
<p>清单文件中依然要指定包名。它将用来在代码只能怪引用 R 类，并解决一些相对的 activity/service 的注册。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span>=<span class="string">"com.example.app"</span>&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong> 如果存在多个清单文件(例如一个产品修饰指定的清单和一个构建类型清单)，包名在这些清单中是可选的。如果在这些清单中指定包名，这些包名应该和 <code>src/main</code> 文件夹下的清单中的包名完全一样。</p>
</blockquote>
<p>想了解构建文件和过程的更多信息，查看<a href="http://www.linfuyan.com/android-build-system-overview" target="_blank" rel="external"> Android 构建系统概览</a>。</p>
<h3 id="配置签名设置">配置签名设置</h3><p>debug 和 release 版本的应用区别在于是否应用程序能够在安全设备上被调试以及 APK 如何被签名。构建系统使用默认的密钥和已知证书的凭证来签名 debug 版本以避免在构建时密码提醒。构建系统不会签名 release 版本，除非为这次构建明确定义一个签名配置。如果你还没有 release 密钥，可以像<a href="https://developer.android.com/tools/publishing/app-signing.html" target="_blank" rel="external">签名应用程序</a>中一样，自己生成一个。</p>
<h2 id="使用构建变种工作">使用构建变种工作</h2><p>这一章节描述构建系统如何从单一的项目来创建相同应用程序的不同版本。当你的应用程序存在一个 Demo 版本和一个付费版本，或者在 Google Play 上针对不同配置的设备发布多个 Apk 包时，这将变得非常有用。</p>
<p>构建系统使用产品口味来创建应用程序的不同产品版本。每个产品版本可以有不同的功能和设备要求。构建系统同时使用构建变形来应用不同的构建和打包设置到每个产品版本。每个产品口味和构建类型组合形成构建变种。构建系统则为应用程序的每个构建变种生成不同的 APK。</p>
<h3 id="构建变种">构建变种</h3><p>这个实例项目包含两个默认的构建类型( debug 和 release )和两个对应应用类型( demo 和 full)的 产品口味。构建变种的更多高级用法，请查看<a href="http://www.linfuyan.com/android-build-system-overview" target="_blank" rel="external"> Android 构建系统概览</a>。</p>
<h4 id="产品口味">产品口味</h4><p>创建应用程序的不同产品版本：</p>
<ol>
<li>在构建文件中定义产品口味。</li>
<li>为每种口味创建额外的源文件夹。</li>
<li>添加特定口味的源文件到应用程序中。</li>
</ol>
<p>接下来的部分使用 <code>BuildSystemExample</code> 项目来详细介绍这些过程。为 <code>BuildSystemExample</code> 应用创建两种口味，一个 demo 和一个 full。两种口味共享 <code>MainActivity</code>，在这个 Activity 中添加一个按钮来启动一个新的 <code>SecondActivity</code>。这个新的 Activity 则在不同变种中不同，因此你可以模拟这样的状态：让 full 口味的新 Activity 具有比 demo 口味更多的功能。在练习的最后，你将得到两个不同的 APK 包，每种口味一个。</p>
<h4 id="在构建中定义产品口味">在构建中定义产品口味</h4><p>要定义两种产品口味，编辑 <code>app</code> 模块的构建文件来添加下面的配置。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">...</span></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">    defaultConfig &#123; <span class="attribute">...</span> &#125;</span><br><span class="line">    signingConfigs &#123; <span class="attribute">...</span> &#125;</span><br><span class="line">    buildTypes &#123; <span class="attribute">...</span> &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        demo &#123;</span><br><span class="line">            applicationId <span class="string">"com.buildsystemexample.app.demo"</span></span><br><span class="line">            versionName <span class="string">"1.0-demo"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">full</span> &#123;</span><br><span class="line">            applicationId <span class="string">"com.buildsystemexample.app.full"</span></span><br><span class="line">            versionName <span class="string">"1.0-full"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">...</span></span><br></pre></td></tr></table></figure>
<p>产品口味定义支持相同的属性，如 <code>defaultConfig</code> 元素。所有口味的基础配置在 <code>defaultConfig</code> 中指定，每种口味可以覆盖任何的默认值。这个构建文件使用 <code>applicationId</code> 属性为每种口味分配不同的包名：因为每种口味定义创建一个不同的应用程序，每个应用程序需要区分包名。</p>
<blockquote>
<p><strong>注意：</strong> 使用多 APK 支持在 Google Play 市场发布应用程序，需要为所有的变种分配相同的包名和不同的 <code>versionCode</code>。要发布不同变种为 Google Play 上的独立应用，则要为每个变种分配不同的包名。</p>
</blockquote>
<h4 id="为每个变种创建额外的源文件夹">为每个变种创建额外的源文件夹</h4><p>创建源文件夹，并为每种口味添加 <code>SecondActivity</code>。为 demo 口味创建源文件夹结构：</p>
<ol>
<li>在 <code>Project</code> 面板，展开 <code>BuildSystemExample</code>，然后展开 <code>app</code> 目录。</li>
<li>右击 <code>app</code> 目录下的 <code>src</code> 文件夹并选择 <strong>New &gt; Direcory</strong>。</li>
<li>输入 “demo” 作为新文件夹名称，并点击 <strong>OK</strong>。</li>
<li>类似地步骤，创建下面的文件夹：<ul>
<li><code>app/src/demo/java</code></li>
<li><code>app/src/demo/res</code></li>
<li><code>app/src/demo/res/layout</code></li>
<li><code>app/src/demo/res/values</code></li>
</ul>
</li>
</ol>
<p>最终的目录结构如下图：</p>
<p><img src="https://developer.android.com/images/tools/as-demoflavordirs.png" alt="demo 口味的新源文件夹"> </p>
<h4 id="为每种口味添加新的_Activity">为每种口味添加新的 Activity</h4><p>添加 <code>SecondActivity</code> 到 demo 口味：</p>
<ol>
<li>在 <code>Project</code> 面板，右击 <code>app</code> 模块并选择 <strong>New &gt; Activity</strong>。</li>
<li>选择 <strong>Blank Activity</strong> 并点击 <strong>Next</strong>。</li>
<li>输入 “SecondActivity” 作为 Activity 名称。</li>
<li>输入 “com.buildsystemexample.app” 作为包名并点击 <strong>Finish</strong>。</li>
<li>右击 app/src/demo 下的 java 目录，并选择 <strong>New &gt; Package</strong>。</li>
<li>输入 “com.buildsystemexample.app” 作为包名并点击 <strong>OK</strong>。</li>
<li>拖动 SecondActivity，并将其放到 app/src/demo/java 下的新包中。</li>
<li>接受默认值并点击 <strong>Refactor</strong>。</li>
</ol>
<p>添加 SecondActivity 的布局和字符串资源到 demo 口味：</p>
<ol>
<li>从 app/src/main/res/layout 拖动 activity_second.xml 到 app/src/demo/res/layout 中。</li>
<li>接受窗口中出现的默认值并点击 <strong>OK</strong>。</li>
<li>从 app/src/main/res 复制 strings.xml 到 app/src/demo/res 中。</li>
<li>用下面的内容替换 strings.xml 新副本中的内容。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">string</span> <span class="attribute">name</span>=<span class="value">"hello_world"</span>&gt;</span>Demo version only.<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来通过复制 demo 口味来添加源文件夹和 <code>SecondActivity</code> 到 full 口味：</p>
<ol>
<li>在 <code>Project</code> 面板，右击 app/src 下的 demo 目录，并选择 <strong>Copy</strong>。</li>
<li>右击 app/ 下的 src/ 目录，并选择 <strong>Paste</strong>。</li>
<li>当窗口出现是，输入 full 作为新的名字，并 <strong>OK</strong>。</li>
<li>使用下面的内容替换 src/full/res/values 下的 strings.xml 的内容：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">string</span> <span class="attribute">name</span>=<span class="value">"hello_world"</span>&gt;</span>This is the full version!<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>从现在开始，你可以在每种口味上独立的开发 <code>SecondActivity</code>。例如，你可以在 full 口味中为这个 Activity 添加更多的功能。</p>
</blockquote>
<p>想要在特定口味上的文件进行工作，点击 IDE 窗口左上角的 <strong>Build Variants</strong>，并在”构建变种”面板选择你想要修改的口味，如下图所示。 Android Studio 会为没有在构建变种面板上选中的口味的源文件中显示错误，但是这不影响构建输出。</p>
<p><img src="https://developer.android.com/images/tools/as-buildvariants.png" alt="构建变种面板"> </p>
<h4 id="从主_Activity_启动特定口味的_Activity">从主 Activity 启动特定口味的 Activity</h4><p>由于特定口味的 Activity (<code>SecondActivity</code>)在两种口味中拥有相同的包名和 activity 名称，可以从所有口味共同的主 Activity 中启动它。修改主 Activity 如下：</p>
<p>1、 编辑 <code>activity_main.xml</code>，并添加新的按钮到 <code>MainActivity</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="title">Button</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/button2"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">"@string/button2"</span></span><br><span class="line">        <span class="attribute">android:onClick</span>=<span class="value">"onButton2Clicked"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、 点击布局文件中标记为红色的区域并点击 <strong>Alt + Enter</strong>。按照 Android Studio 的提示添加一个值为 “Open Second Activity” 的字符串资源，以及 <code>onButton2Clicked</code> 方法到 <code>MainActivity</code>。<br>3、 添加下面的代码到 <code>MainActivity</code> 中的 <code>onButton2Clicked</code> 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onButton2Clicked</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, SecondActivity.<span class="keyword">class</span>);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、 编辑应用的 manifest 文件来包含 <code>SecondActivity</code> 的引用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span> <span class="attribute">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="title">activity</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"com.buildsystemexample.app.SecondActivity"</span></span><br><span class="line">            <span class="attribute">android:label</span>=<span class="value">"@string/title_activity_second"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="构建类型">构建类型</h4><p>构建类型代表了为每个应用程序构建打包的版本。默认系统提供了 debug 和 release 的构建类型。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123; ... &#125;</span><br><span class="line">    signingConfigs &#123; ... &#125;</span><br><span class="line">    buildTypes &#123; ... &#125;</span><br><span class="line">    productFlavors <span class="decorator">&#123;...&#125;</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'</span><br><span class="line">        &#125;</span><br><span class="line">         debug &#123;</span><br><span class="line">            debuggable <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>虽然只有 release 的构建类型出现在默认的 build.gradle 文件中，但每个构建都提供了 release 和 debug 的构建类型。</p>
</blockquote>
<p>在这个实例中，产品口味和构建类型创建了下面的构建变种：</p>
<ul>
<li>demoDebug</li>
<li>demoRelease</li>
<li>fullDebug</li>
<li>fullRelease</li>
</ul>
<p>要构建这个实例，点击 Android Studio 上的 <strong>Build</strong> 选项按钮，或者从命令行调用 <code>assemble</code> 任务。</p>
<blockquote>
<p><strong>注意：**</strong>Build &gt; Make Project<strong>选项将编译整个项目中自从上一次编译之后所有被修改过的源文件。</strong>Build &gt; Rebuild Project**选项将重新编译项目中的所有源文件。</p>
</blockquote>
<p>每个构建变种将创建独立的输出文件夹。</p>
<p>原文链接：<a href="https://developer.android.com/intl/zh-cn/tools/building/configuring-gradle.html" target="_blank" rel="external">Build Configuration Basics</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/how-to-identify-smart-people-around-you/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          如何辨认身边的聪明人？
        
      </div>
    </a>
  
  
    <a href="/android-build-system-overview/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android 构建系统概览</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="configuring-gradle-builds" data-title="配置 Gradle 构建" data-url="http://yoursite.com/configuring-gradle-builds/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"linfuyan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 linfuyan
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>